---
title: dVaults
description: Taproot-based, MAST-committed spend programs that secure BTC
---

# ğŸ” dVaults: Programmable Bitcoin Vaults

A **dVault** is a Bitcoin Taproot UTXO (BIP341) whose spend conditions are committed via **MAST/Tapscript** (BIP342).  
dVaults anchor Surgeâ€™s collateral: BTC never leaves Bitcoin; spends are only possible under pre-committed, auditable conditions.

## Core Scripting

- Each vault commits a **taptree** of spend leaves (miniscript/tapscript). Only the executed leaf is revealed on spend; unused branches remain hidden.
- The **key path** (MuSig2 aggregate of user + signer epoch) handles the common â€œrepaymentâ€ flow cheaply.
- **Script leaves** handle exceptional paths (liquidation, signer migration, escape hatch) with timelocks.

## Spend Paths

- **Repayment** â€” BTC can be spent via the **key path** by `MuSig2(P_user, P_epoch)` after the execution environment attests that debt was repaid.  
  _Enforced by signers + state proofs; the script enforces signatures only._
- **Liquidation** â€” If CR < MinCR, signers spend via a **CSV-gated** script leaf. The spend **creates outputs**: (i) discounted sale to Stability Pool, (ii) change re-locked to a fresh dVault.  
  _CR check is off-chain; the script enforces signer control + delay._
- **Signer migration** â€” After a cooldown, funds are re-locked to the **next signer epoch** (key rotation).
- **Escape hatch** â€” After a long **CLTV**, the depositor can unilaterally recover with a dedicated recovery key.

## Example Script Structures

Below are simplified pseudocode representations of how Surge dVaults enforce these conditions on Bitcoin.

### 1. Escape Hatch (User Recovery)

```bitcoin-script
# User can recover BTC unilaterally after 30 days
OP_CHECKLOCKTIMEVERIFY(30d)
OP_CHECKSIG(user_pubkey)
```

### 2. Repayment Path (Ledger-Validated Unlock)

```bitcoin-script
# Requires depositor + MPC signers (cb-mpc)
# Only valid if repayment event is confirmed in execution environment
AND(
    OP_CHECKSIG(user_pubkey),
    OP_CHECKSIG(mpc_aggkey_epoch)
)
```

### 3. Liquidation Path (Micro-Liquidations)

```bitcoin-script
# Signers + Stability Pool key can spend part of BTC if CR < MinCR
AND(
    OP_CHECKSIG(mpc_aggkey_epoch),
    OP_CHECKSIG(stability_pool_key)
)
# Typically combined with OP_CHECKSEQUENCEVERIFY to throttle liquidation slices
```

### 4. Migration Path (Signer Epoch Rotation)

```bitcoin-script
# Allows re-locking under a new signer set key after cooldown
OP_CHECKSEQUENCEVERIFY(cooldown_blocks)
OP_CHECKSIG(new_mpc_aggkey_epoch+1)
```

## Lifecycle

1. **Deposit** â€” User locks BTC to the Taproot address (key path = `MuSig2(P_user, P_epoch)`).
2. **Borrow** â€” Execution environment issues stablecoins against the attested deposit.
3. **Monitoring** â€” BTC/USD oracle updates CR; state commits record epochs, debts, and Stability Pool balances.
4. **Incremental Liquidations** â€” If `CR < MinCR`, signers spend via the liquidation leaf. The spend MUST produce:
   - **SP purchase** â€” discounted BTC to the Stability Pool, and
   - **Relock** â€” change re-locked to a new dVault taptree for the user (fresh UTXO).
5. **Repayment/Close** â€” Upon debt repayment, signers co-sign the key-path spend, moving BTC per user instructions (often to a new user-controlled output).

## Security Anchors

- **On-chain invariants (script):** Schnorr key ownership, `CSV/CLTV` timelocks, branch commitment in MAST.
- **Off-chain invariants (signers/state):** CR evaluation, repayment attestation, SP discount schedule, and epoch rotation rules tied to the execution environmentâ€™s state root.
- **Signer tech:** Coinbase `cb-mpc` with **MuSig2** (Schnorr) for Taproot keys; threshold **ECDSA** only where interop requires it (non-Bitcoin contexts).
- **Fee safety:** **RBF/CPFP** recommended for timely confirmation on liquidation/rotation paths.
